@model string

@{
    var modelUrl = Model;
    var viewerId = "model-viewer-" + Guid.NewGuid().ToString("N")[..8];
}

<div class="model-3d-container">
    <model-viewer id="@viewerId"
                  src="@modelUrl"
                  alt="3D Model"
                  auto-rotate
                  camera-controls
                  interaction-prompt="auto"
                  loading="lazy"
                  ar
                  ar-modes="webxr scene-viewer quick-look"
                  style="width: 100%; height: 100%; max-height: 100%; background-color: #f8f9fa; display: block;">

        <!-- Loading placeholder -->
        <div slot="poster" class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i m√¥ h√¨nh 3D...</span>
                </div>
                <div class="mt-2 text-muted">ƒêang t·∫£i m√¥ h√¨nh 3D...</div>
                <small class="text-muted d-block mt-1" id="progress-@viewerId">ƒêang kh·ªüi t·∫°o...</small>
            </div>
        </div>

        <!-- Error fallback -->
        <div slot="error" class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <div>Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh 3D</div>
                <small class="text-muted d-block">C√≥ th·ªÉ do file b·ªã l·ªói ho·∫∑c URL kh√¥ng h·ª£p l·ªá</small>
                <div class="mt-3">
                    <a href="@modelUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> Ki·ªÉm tra file
                    </a>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="model-controls position-absolute" style="bottom: 10px; left: 10px; z-index: 10;">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-light" onclick="resetCamera('@viewerId')" title="Reset g√≥c nh√¨n">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="toggleAutoRotate('@viewerId')" title="B·∫≠t/t·∫Øt xoay t·ª± ƒë·ªông">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="toggleFullscreen('@viewerId')" title="To√†n m√†n h√¨nh">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </model-viewer>
</div>

<style>
    .model-3d-container {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0;
        overflow: hidden;
        background: #f8f9fa;
        /* ƒê·∫£m b·∫£o kh√¥ng c√≥ margin/padding g√¢y overflow */
        margin: 0;
        padding: 0;
        /* ƒê·∫£m b·∫£o container kh√¥ng tr√†n */
        box-sizing: border-box;
    }

    model-viewer {
        --poster-color: transparent;
        --progress-bar-color: #007bff;
        --progress-mask: #ffffff;
        /* ƒê·∫£m b·∫£o model viewer kh√¥ng tr√†n ra ngo√†i */
        position: relative;
        overflow: hidden;
        border-radius: 0;
        /* Fix cho Chrome/Safari */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
    }

    .model-controls {
        opacity: 0;
        transition: opacity 0.3s ease;
        /* ƒê·∫£m b·∫£o controls kh√¥ng tr√†n ra ngo√†i */
        max-width: calc(100% - 20px);
    }

    .model-3d-container:hover .model-controls {
        opacity: 1;
    }

    /* Responsive controls cho mobile */
    @@media (max-width: 768px) {
        .model-controls

    {
        opacity: 1; /* Always show on mobile */
        bottom: 5px;
        left: 5px;
    }

    .model-controls .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    }

    /* Fix cho m·ªôt s·ªë tr√¨nh duy·ªát c√≥ th·ªÉ render sai */
    @@supports (-webkit-appearance: none) {
        model-viewer

    {
        /* Safari specific fixes */
        isolation: isolate;
    }

    }</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modelViewer = document.getElementById('@viewerId');
        const progressElement = document.getElementById('progress-@viewerId');

        if (modelViewer) {
            console.log('üîß Model Viewer initialized for:', '@modelUrl');

            if (progressElement) progressElement.textContent = 'ƒêang t·∫£i m√¥ h√¨nh...';

            modelViewer.addEventListener('load', function() {
                console.log('‚úÖ Model loaded successfully!');
                if (progressElement) progressElement.textContent = 'T·∫£i th√†nh c√¥ng!';
            });

            modelViewer.addEventListener('error', function(e) {
                console.error('‚ùå Model failed to load:', e);
                if (progressElement) progressElement.textContent = 'L·ªói t·∫£i m√¥ h√¨nh!';
            });

            modelViewer.addEventListener('progress', function(e) {
                const progress = Math.round(e.detail.totalProgress * 100);
                console.log('üìä Loading progress:', progress + '%');
                if (progressElement) progressElement.textContent = `ƒê√£ t·∫£i: ${progress}%`;
            });

            // ƒê·∫£m b·∫£o model viewer fit ƒë√∫ng trong container
            const container = modelViewer.closest('.model-3d-container');
            if (container) {
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        // Force model viewer to respect container bounds
                        modelViewer.style.width = '100%';
                        modelViewer.style.height = '100%';
                    }
                });
                resizeObserver.observe(container);
            }
        }
    });

    function resetCamera(viewerId) {
        const modelViewer = document.getElementById(viewerId);
        if (modelViewer && modelViewer.loaded) {
            try {
                modelViewer.cameraOrbit = 'auto auto auto';
                modelViewer.cameraTarget = 'auto auto auto';
                console.log('üì∑ Camera reset');
            } catch (error) {
                console.warn('‚ö†Ô∏è Camera reset failed:', error);
            }
        }
    }

    function toggleAutoRotate(viewerId) {
        const modelViewer = document.getElementById(viewerId);
        if (modelViewer) {
            try {
                modelViewer.autoRotate = !modelViewer.autoRotate;
                const button = event.target.closest('button');
                if (modelViewer.autoRotate) {
                    button.classList.add('active');
                    button.style.backgroundColor = '#0d6efd';
                    button.style.color = 'white';
                } else {
                    button.classList.remove('active');
                    button.style.backgroundColor = '';
                    button.style.color = '';
                }
                console.log('üîÑ Auto rotate:', modelViewer.autoRotate);
            } catch (error) {
                console.warn('‚ö†Ô∏è Auto rotate failed:', error);
            }
        }
    }

    function toggleFullscreen(viewerId) {
        try {
            const container = document.getElementById(viewerId).closest('.card');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Fullscreen not supported:', error);
        }
    }
</script>