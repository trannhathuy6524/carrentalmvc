@using carrentalmvc.Models
@using carrentalmvc.Models.Enums
@model Rental
@{
    ViewData["Title"] = "Thanh to√°n ƒë∆°n thu√™ #" + Model.RentalId;

    // Get data from ViewBag
    var totalPrice = (decimal)(ViewBag.TotalPrice ?? 0m);
    var totalPaid = (decimal)(ViewBag.TotalPaid ?? 0m);
    var remainingAmount = (decimal)(ViewBag.RemainingAmount ?? 0m);
    var depositRequired = (decimal)(ViewBag.DepositRequired ?? 0m);
    var depositPaid = (decimal)(ViewBag.DepositPaid ?? 0m);
    var depositRemaining = (decimal)(ViewBag.DepositRemaining ?? 0m);
    var hasDeposit = (bool)(ViewBag.HasDeposit ?? false);
    var suggestedPaymentType = (PaymentType)(ViewBag.SuggestedPaymentType ?? PaymentType.Deposit);
    var suggestedAmount = (decimal)(ViewBag.SuggestedAmount ?? 0m);

    var getPaymentMethodText = ViewBag.GetPaymentMethodText as Func<PaymentMethod, string>;
    var getPaymentTypeText = ViewBag.GetPaymentTypeText as Func<PaymentType, string>;
    var getRentalStatusText = ViewBag.GetRentalStatusText as Func<RentalStatus, string>;

    var carImageUrl = Model.Car?.CarImages?.FirstOrDefault(img => img.IsPrimary)?.ImageUrl ?? Model.Car?.CarImages?.FirstOrDefault()?.ImageUrl;
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Rentals">ƒê∆°n thu√™ c·ªßa t√¥i</a></li>
                    <li class="breadcrumb-item"><a asp-action="Details" asp-controller="Rentals" asp-route-id="@Model.RentalId">ƒê∆°n thu√™ #@Model.RentalId</a></li>
                    <li class="breadcrumb-item active">Thanh to√°n</li>
                </ol>
            </nav>

            <h2 class="mb-4">
                <i class="fas fa-credit-card me-2"></i>Thanh to√°n ƒë∆°n thu√™ #@Model.RentalId
            </h2>

            <div class="row">
                <!-- Left Column: Payment Form -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-money-bill-wave me-2"></i>Th√¥ng tin thanh to√°n
                            </h5>
                        </div>
                        <div class="card-body">
                            <form asp-action="Create" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="rentalId" value="@Model.RentalId" />

                                <!-- Payment Type Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Lo·∫°i thanh to√°n <span class="text-danger">*</span></label>
                                    
                                    <!-- Option 1: Deposit Payment -->
                                    @if (depositRemaining > 0)
                                    {
                                        <div class="card mb-3 payment-option @(suggestedPaymentType == PaymentType.Deposit ? "border-primary" : "")">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input payment-type-radio" 
                                                           type="radio" 
                                                           name="paymentType" 
                                                           id="paymentTypeDeposit" 
                                                           value="@((int)PaymentType.Deposit)"
                                                           data-amount="@depositRemaining"
                                                           checked="@(suggestedPaymentType == PaymentType.Deposit)" />
                                                    <label class="form-check-label w-100" for="paymentTypeDeposit">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <i class="fas fa-piggy-bank text-info me-2"></i>
                                                                    Thanh to√°n ƒë·∫∑t c·ªçc (30%)
                                                                    @if (suggestedPaymentType == PaymentType.Deposit)
                                                                    {
                                                                        <span class="badge bg-warning text-dark ms-2">Khuy·∫øn ngh·ªã</span>
                                                                    }
                                                                </h6>
                                                                <small class="text-muted">
                                                                    Y√™u c·∫ßu: <strong>@depositRequired.ToString("N0") VNƒê</strong><br />
                                                                    ƒê√£ thanh to√°n: @depositPaid.ToString("N0") VNƒê<br />
                                                                    C√≤n thi·∫øu: <strong class="text-danger">@depositRemaining.ToString("N0") VNƒê</strong>
                                                                </small>
                                                            </div>
                                                            <div class="text-end">
                                                                <h4 class="text-info mb-0">@depositRemaining.ToString("N0")</h4>
                                                                <small class="text-muted">VNƒê</small>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                                @if (!hasDeposit)
                                                {
                                                    <div class="alert alert-warning mt-2 mb-0 py-2">
                                                        <small>
                                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                                            <strong>L∆∞u √Ω:</strong> Ch·ªß xe ch·ªâ x√°c nh·∫≠n ƒë∆°n khi b·∫°n ƒë√£ thanh to√°n ƒë·ªß 30% ƒë·∫∑t c·ªçc.
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }

                                    <!-- Option 2: Full Payment -->
                                    <div class="card mb-3 payment-option @(suggestedPaymentType == PaymentType.RentalFee && hasDeposit ? "border-primary" : "")">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input payment-type-radio" 
                                                       type="radio" 
                                                       name="paymentType" 
                                                       id="paymentTypeRentalFee" 
                                                       value="@((int)PaymentType.RentalFee)"
                                                       data-amount="@remainingAmount"
                                                       checked="@(suggestedPaymentType == PaymentType.RentalFee)" />
                                                <label class="form-check-label w-100" for="paymentTypeRentalFee">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <h6 class="mb-1">
                                                                <i class="fas fa-money-check-alt text-success me-2"></i>
                                                                Thanh to√°n to√†n b·ªô
                                                                @if (hasDeposit)
                                                                {
                                                                    <span class="badge bg-success ms-2">ƒê√£ ƒë·ªß ƒë·∫∑t c·ªçc</span>
                                                                }
                                                            </h6>
                                                            <small class="text-muted">
                                                                T·ªïng gi√° tr·ªã: @totalPrice.ToString("N0") VNƒê<br />
                                                                ƒê√£ thanh to√°n: @totalPaid.ToString("N0") VNƒê<br />
                                                                C√≤n l·∫°i: <strong class="text-danger">@remainingAmount.ToString("N0") VNƒê</strong>
                                                            </small>
                                                        </div>
                                                        <div class="text-end">
                                                            <h4 class="text-success mb-0">@remainingAmount.ToString("N0")</h4>
                                                            <small class="text-muted">VNƒê</small>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Option 3: Custom Amount -->
                                    <div class="card mb-3 payment-option">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input payment-type-radio" 
                                                       type="radio" 
                                                       name="paymentType" 
                                                       id="paymentTypeCustom" 
                                                       value="@((int)PaymentType.RentalFee)"
                                                       data-amount="0" />
                                                <label class="form-check-label w-100" for="paymentTypeCustom">
                                                    <h6 class="mb-1">
                                                        <i class="fas fa-edit text-secondary me-2"></i>
                                                        S·ªë ti·ªÅn t√πy ch·ªânh
                                                    </h6>
                                                    <small class="text-muted">Nh·∫≠p s·ªë ti·ªÅn b·∫°n mu·ªën thanh to√°n (t·ªëi ƒëa @remainingAmount.ToString("N0") VNƒê)</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Amount Input -->
                                <div class="mb-3">
                                    <label for="amount" class="form-label fw-bold">S·ªë ti·ªÅn thanh to√°n <span class="text-danger">*</span></label>
                                    <div class="input-group input-group-lg">
                                        <input type="number" 
                                               class="form-control" 
                                               id="amount" 
                                               name="amount" 
                                               min="1" 
                                               max="@remainingAmount" 
                                               step="1000"
                                               value="@suggestedAmount"
                                               required />
                                        <span class="input-group-text">VNƒê</span>
                                    </div>
                                    <small class="text-muted">T·ªëi thi·ªÉu: 1,000 VNƒê | T·ªëi ƒëa: @remainingAmount.ToString("N0") VNƒê</small>
                                </div>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label fw-bold">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span></label>
                                    <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                        <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
                                        <option value="@((int)PaymentMethod.Cash)">üíµ @(getPaymentMethodText?.Invoke(PaymentMethod.Cash) ?? "Ti·ªÅn m·∫∑t")</option>
                                        <option value="@((int)PaymentMethod.BankTransfer)" selected>üè¶ @(getPaymentMethodText?.Invoke(PaymentMethod.BankTransfer) ?? "Chuy·ªÉn kho·∫£n")</option>
                                        <option value="@((int)PaymentMethod.EWallet)">üì± @(getPaymentMethodText?.Invoke(PaymentMethod.EWallet) ?? "V√≠ ƒëi·ªán t·ª≠")</option>
                                        <option value="@((int)PaymentMethod.CreditCard)">üí≥ @(getPaymentMethodText?.Invoke(PaymentMethod.CreditCard) ?? "Th·∫ª t√≠n d·ª•ng")</option>
                                    </select>
                                </div>

                                <!-- Bank Transfer Information -->
                                <div id="bankTransferInfo" class="alert alert-info" style="display: none;">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-university me-2"></i>Th√¥ng tin chuy·ªÉn kho·∫£n
                                    </h6>
                                    <hr />
                                    <p class="mb-2"><strong>Ng√¢n h√†ng:</strong> Vietcombank</p>
                                    <p class="mb-2"><strong>S·ªë t√†i kho·∫£n:</strong> 1234567890</p>
                                    <p class="mb-2"><strong>Ch·ªß t√†i kho·∫£n:</strong> @(Model.Car?.Owner?.FullName ?? "N/A")</p>
                                    <p class="mb-2">
                                        <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong> 
                                        <code class="bg-white text-dark p-2 d-inline-block">THANHTOAN @Model.RentalId @(Model.Renter?.FullName ?? "")</code>
                                    </p>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Vui l√≤ng chuy·ªÉn kho·∫£n ch√≠nh x√°c n·ªôi dung ƒë·ªÉ ƒë∆∞·ª£c x√°c nh·∫≠n t·ª± ƒë·ªông.
                                    </small>
                                </div>

                                <!-- Notes -->
                                <div class="mb-4">
                                    <label for="notes" class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ thanh to√°n (n·∫øu c√≥)..."></textarea>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a asp-action="Details" asp-controller="Rentals" asp-route-id="@Model.RentalId" 
                                       class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-check-circle me-2"></i>X√°c nh·∫≠n thanh to√°n
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Rental Summary -->
                <div class="col-lg-4">
                    <!-- Rental Info Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-file-contract me-2"></i>Th√¥ng tin ƒë∆°n thu√™
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Car Image -->
                            @if (!string.IsNullOrEmpty(carImageUrl))
                            {
                                <img src="@carImageUrl" alt="@Model.Car?.Name" class="img-fluid rounded mb-3" />
                            }

                            <h6 class="text-primary">@(Model.Car?.Name ?? "N/A")</h6>
                            <p class="text-muted small mb-3">@(Model.Car?.Brand?.Name ?? "N/A")</p>

                            <dl class="row mb-0">
                                <dt class="col-6 small">M√£ ƒë∆°n:</dt>
                                <dd class="col-6 small">#@Model.RentalId</dd>

                                <dt class="col-6 small">Tr·∫°ng th√°i:</dt>
                                <dd class="col-6 small">
                                    <span class="badge bg-@GetStatusBadgeClass(Model.Status)">
                                        @(getRentalStatusText?.Invoke(Model.Status) ?? Model.Status.ToString())
                                    </span>
                                </dd>

                                <dt class="col-6 small">Th·ªùi gian thu√™:</dt>
                                <dd class="col-6 small">@((Model.EndDate - Model.StartDate).Days) ng√†y</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Payment Summary Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>T·ªïng quan thanh to√°n
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Total Price -->
                            <div class="d-flex justify-content-between mb-2">
                                <span>T·ªïng gi√° tr·ªã:</span>
                                <strong>@totalPrice.ToString("N0") VNƒê</strong>
                            </div>

                            <!-- Total Paid -->
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-success">ƒê√£ thanh to√°n:</span>
                                <strong class="text-success">-@totalPaid.ToString("N0") VNƒê</strong>
                            </div>

                            <hr />

                            <!-- Remaining -->
                            <div class="d-flex justify-content-between mb-3">
                                <strong>C√≤n l·∫°i:</strong>
                                <h5 class="text-danger mb-0">@remainingAmount.ToString("N0") VNƒê</h5>
                            </div>

                            <!-- Progress Bar -->
                            @{
                                var paymentProgress = totalPrice > 0 ? (totalPaid / totalPrice * 100) : 0;
                            }
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar @(paymentProgress >= 100 ? "bg-success" : "bg-info")" 
                                     role="progressbar" 
                                     style="width: @paymentProgress.ToString("F0")%">
                                    @paymentProgress.ToString("F0")%
                                </div>
                            </div>

                            <!-- Deposit Info -->
                            <div class="mt-3 p-3 border rounded @(hasDeposit ? "border-success bg-success" : "border-warning bg-warning") bg-opacity-10">
                                <h6 class="small mb-2">
                                    <i class="fas fa-piggy-bank me-1"></i>
                                    ƒê·∫∑t c·ªçc (30%)
                                </h6>
                                <div class="d-flex justify-content-between small">
                                    <span>Y√™u c·∫ßu:</span>
                                    <strong>@depositRequired.ToString("N0") VNƒê</strong>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span>ƒê√£ ƒë·∫∑t:</span>
                                    <strong class="@(hasDeposit ? "text-success" : "text-warning")">
                                        @depositPaid.ToString("N0") VNƒê
                                    </strong>
                                </div>
                                @if (!hasDeposit)
                                {
                                    <div class="d-flex justify-content-between small text-danger">
                                        <span>C√≤n thi·∫øu:</span>
                                        <strong>@depositRemaining.ToString("N0") VNƒê</strong>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">T·ªïng k·∫øt thanh to√°n</h6>
                            
                            <dl class="row mb-0">
                                <dt class="col-sm-6">T·ªïng gi√° tr·ªã ƒë∆°n:</dt>
                                <dd class="col-sm-6 text-end">@Model.TotalPrice.ToString("N0") VNƒê</dd>

                                @* ‚úÖ TH√äM: Platform commission breakdown *@
                                @{
                                    var driverFee = Model.ActualDriverFee ?? 0m;
                                    var breakdown = carrentalmvc.Data.Constants.PlatformConstants.GetRevenueBreakdown(Model.TotalPrice, driverFee);
                                }

                                <dt class="col-sm-6 text-muted small">
                                    <i class="fas fa-info-circle"></i> Ph√¢n chia doanh thu:
                                </dt>
                                <dd class="col-sm-6"></dd>

                                <dt class="col-sm-6 text-muted ps-4 small">‚Ä¢ N·ªÅn t·∫£ng (10%):</dt>
                                <dd class="col-sm-6 text-end text-muted small">@breakdown.PlatformFee.ToString("N0") VNƒê</dd>

                                <dt class="col-sm-6 text-muted ps-4 small">‚Ä¢ Ch·ªß xe:</dt>
                                <dd class="col-sm-6 text-end text-muted small">@breakdown.OwnerRevenue.ToString("N0") VNƒê</dd>

                                @if (breakdown.DriverFee > 0)
                                {
                                    <dt class="col-sm-6 text-muted ps-4 small">‚Ä¢ T√†i x·∫ø:</dt>
                                    <dd class="col-sm-6 text-end text-muted small">@breakdown.DriverFee.ToString("N0") VNƒê</dd>
                                }

                                <dt class="col-sm-6">S·ªë ti·ªÅn thanh to√°n:</dt>
                                <dd class="col-sm-6 text-end">
                                    <strong class="text-success" id="paymentAmount">
                                        @suggestedAmount.ToString("N0") VNƒê
                                    </strong>
                                </dd>
                            </dl>

                            <div class="alert alert-info mb-0 mt-2">
                                <small>
                                    <i class="fas fa-shield-alt"></i>
                                    <strong>L∆∞u √Ω:</strong> Ph√≠ n·ªÅn t·∫£ng 10% gi√∫p duy tr√¨ v√† ph√°t tri·ªÉn d·ªãch v·ª•.
                                    B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c h·ªó tr·ª£ 24/7 v√† b·∫£o hi·ªÉm to√†n di·ªán.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Help Card -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>C·∫ßn h·ªó tr·ª£?
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">Li√™n h·ªá v·ªõi ch√∫ng t√¥i n·∫øu b·∫°n c·∫ßn h·ªó tr·ª£</p>
                            <a href="tel:1900xxxx" class="btn btn-outline-primary btn-sm w-100 mb-2">
                                <i class="fas fa-phone me-2"></i>Hotline: 1900 xxxx
                            </a>
                            <a href="mailto:support@example.com" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-envelope me-2"></i>Email h·ªó tr·ª£
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle payment type radio change
            $('.payment-type-radio').change(function () {
                var selectedAmount = $(this).data('amount');
                var isCustom = $(this).attr('id') === 'paymentTypeCustom';

                if (!isCustom && selectedAmount > 0) {
                    $('#amount').val(selectedAmount);
                    $('#amount').attr('readonly', true);
                } else {
                    $('#amount').attr('readonly', false);
                    if (isCustom) {
                        $('#amount').val('').focus();
                    }
                }

                // Highlight selected option
                $('.payment-option').removeClass('border-primary');
                $(this).closest('.payment-option').addClass('border-primary');
            });

            // Handle payment method change
            $('#paymentMethod').change(function () {
                if ($(this).val() == '@((int)PaymentMethod.BankTransfer)') {
                    $('#bankTransferInfo').slideDown();
                } else {
                    $('#bankTransferInfo').slideUp();
                }
            });

            // Trigger initial selection
            $('.payment-type-radio:checked').trigger('change');
            $('#paymentMethod').trigger('change');

            // Form validation
            $('form').submit(function (e) {
                var amount = parseFloat($('#amount').val());
                var remainingAmount = @remainingAmount;

                if (amount <= 0) {
                    e.preventDefault();
                    alert('S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0');
                    return false;
                }

                if (amount > remainingAmount) {
                    e.preventDefault();
                    alert('S·ªë ti·ªÅn kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë ti·ªÅn c√≤n l·∫°i: ' + remainingAmount.toLocaleString('vi-VN') + ' VNƒê');
                    return false;
                }

                // Show loading
                var $btn = $(this).find('button[type="submit"]');
                $btn.prop('disabled', true);
                $btn.html('<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...');
            });

            // Format number input
            $('#amount').on('input', function () {
                var val = $(this).val().replace(/[^0-9]/g, '');
                if (val) {
                    $(this).val(val);
                }
            });
        });
    </script>
}

@section Styles {
    <style>
        .payment-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .payment-option:hover {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .payment-option.border-primary {
            border-width: 2px !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        #bankTransferInfo code {
            font-size: 0.9rem;
            padding: 0.5rem;
        }
    </style>
}

@functions {
    private string GetStatusBadgeClass(RentalStatus status)
    {
        return status switch
        {
            RentalStatus.Pending => "warning",
            RentalStatus.Confirmed => "info",
            RentalStatus.Active => "success",
            RentalStatus.Completed => "primary",
            RentalStatus.Cancelled => "danger",
            RentalStatus.Overdue => "danger",
            _ => "secondary"
        };
    }
}
