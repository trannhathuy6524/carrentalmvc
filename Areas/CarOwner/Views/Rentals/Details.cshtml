@using carrentalmvc.Models
@using carrentalmvc.Models.Enums
@model Rental
@{
    ViewData["Title"] = $"Chi tiết đơn thuê xe #{Model.RentalId}";

    // Get data from ViewBag
    var payments = ViewBag.Payments as List<Payment> ?? new List<Payment>();
    var totalPaid = ViewBag.TotalPaid ?? 0m;
    var remainingAmount = ViewBag.RemainingAmount ?? 0m;
    var hasPendingPayments = ViewBag.HasPendingPayments ?? false;

    var canConfirm = ViewBag.CanConfirm ?? false;
    var canStart = ViewBag.CanStart ?? false;
    var canComplete = ViewBag.CanComplete ?? false;
    var canCancel = ViewBag.CanCancel ?? false;

    var getRentalStatusText = ViewBag.GetRentalStatusText as Func<RentalStatus, string>;
    var getCarStatusText = ViewBag.GetCarStatusText as Func<CarStatus, string>;
    var getPaymentMethodText = ViewBag.GetPaymentMethodText as Func<PaymentMethod, string>;
    var getPaymentTypeText = ViewBag.GetPaymentTypeText as Func<PaymentType, string>;
    var getPaymentStatusText = ViewBag.GetPaymentStatusText as Func<PaymentStatus, string>;

    var isFullyPaid = ViewBag.IsFullyPaid ?? false;
    var depositRequired = ViewBag.DepositRequired ?? 0m;
    var hasDeposit = ViewBag.HasDeposit ?? false;
    var depositPaid = ViewBag.DepositPaid ?? 0m;
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-file-contract"></i> Chi tiết đơn thuê xe #@Model.RentalId</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <!-- ✅ NÚT XÁC NHẬN ĐƠN GIẢN -->
            @if (canConfirm)
            {
                <form asp-action="Confirm" asp-route-id="@Model.RentalId" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-success"
                            onclick="return confirm('@(Model.RequiresDriver ? "Lưu ý: Chỉ xác nhận khi đã có tài xế nhận đơn. Bạn có chắc muốn xác nhận?" : "Bạn có chắc muốn xác nhận đơn thuê này?")')">
                        <i class="fas fa-check"></i> Xác nhận
                    </button>
                </form>
            }

            @if (canStart)
            {
                <form asp-action="Start" asp-route-id="@Model.RentalId" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-info"
                            onclick="return confirm('Bạn có chắc muốn bắt đầu đơn thuê này?')">
                        <i class="fas fa-play"></i> Bắt đầu
                    </button>
                </form>
            }

            @if (canComplete)
            {
                <a asp-action="Complete" asp-route-id="@Model.RentalId" class="btn btn-sm btn-primary">
                    <i class="fas fa-flag-checkered"></i> Hoàn thành
                </a>
            }

            @if (canCancel)
            {
                <button type="button" class="btn btn-sm btn-danger" onclick="showCancelModal()">
                    <i class="fas fa-times"></i> Hủy đơn
                </button>
            }
        </div>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-md-8">
        <!-- Rental Information -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Thông tin đơn thuê xe</h6>
                    <span class="badge bg-@(GetRentalStatusBadgeClass(Model.Status)) fs-6">
                        @(getRentalStatusText != null ? getRentalStatusText(Model.Status) : Model.Status.ToString())
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- ✅ THÊM: Hiển thị thông tin tài xế nếu đơn yêu cầu tài xế -->
                @if (Model.RequiresDriver)
                {
                    <div class="alert @(GetDriverAlertClass(Model)) mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-tie fa-2x me-3"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="fas fa-steering-wheel me-1"></i>
                                    Đơn thuê có tài xế
                                </h6>
                                
                                @if (!string.IsNullOrEmpty(Model.DriverId) && Model.Driver != null)
                                {
                                    <!-- ✅ ĐÃ CÓ TÀI XẾ TỰ NHẬN -->
                                    <p class="mb-0">
                                        <strong>Tài xế:</strong> @Model.Driver.FullName
                                        @if (!string.IsNullOrEmpty(Model.Driver.PhoneNumber))
                                        {
                                            <span class="ms-2">
                                                <i class="fas fa-phone"></i> 
                                                <a href="tel:@Model.Driver.PhoneNumber">@Model.Driver.PhoneNumber</a>
                                            </span>
                                        }
                                    </p>
                                    
                                    @if (Model.DriverAccepted == true)
                                    {
                                        <small class="text-success d-block mt-1">
                                            <i class="fas fa-check-circle"></i>
                                            Tài xế đã tự nhận và chấp nhận đơn
                                        </small>
                                    }
                                    else if (Model.DriverAccepted == null)
                                    {
                                        <small class="text-warning d-block mt-1">
                                            <i class="fas fa-clock"></i>
                                            Chờ tài xế xác nhận
                                        </small>
                                    }
                                    else
                                    {
                                        <small class="text-danger d-block mt-1">
                                            <i class="fas fa-times-circle"></i>
                                            Tài xế đã từ chối
                                        </small>
                                    }
                                    
                                    @if (Model.DriverAssignedAt.HasValue)
                                    {
                                        <small class="text-muted d-block mt-1">
                                            Tài xế nhận đơn lúc: @Model.DriverAssignedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    }
                                }
                                else
                                {
                                    <!-- ✅ CHƯA CÓ TÀI XẾ NHẬN -->
                                    <p class="mb-0 text-warning">
                                        <i class="fas fa-hourglass-half"></i>
                                        Chưa có tài xế nhận đơn. 
                                        @if (Model.Status == RentalStatus.Pending)
                                        {
                                            <span>Đơn sẽ hiển thị cho tài xế sau khi bạn xác nhận thanh toán đặt cọc.</span>
                                        }
                                    </p>
                                }
                            </div>
                        </div>
                    </div>
                }

                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Mã đơn thuê:</dt>
                            <dd class="col-sm-7"><strong>#@Model.RentalId</strong></dd>

                            <dt class="col-sm-5">Khách hàng:</dt>
                            <dd class="col-sm-7">@(Model.Renter?.FullName ?? "N/A")</dd>

                            @if (!string.IsNullOrEmpty(Model.Renter?.Email))
                            {
                                <dt class="col-sm-5">Email:</dt>
                                <dd class="col-sm-7">
                                    <a href="mailto:@Model.Renter.Email">@Model.Renter.Email</a>
                                </dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Renter?.PhoneNumber))
                            {
                                <dt class="col-sm-5">Điện thoại:</dt>
                                <dd class="col-sm-7">
                                    <a href="tel:@Model.Renter.PhoneNumber">@Model.Renter.PhoneNumber</a>
                                </dd>
                            }

                            <dt class="col-sm-5">Ngày bắt đầu:</dt>
                            <dd class="col-sm-7">@Model.StartDate.ToString("dd/MM/yyyy HH:mm")</dd>

                            <dt class="col-sm-5">Ngày kết thúc:</dt>
                            <dd class="col-sm-7">@Model.EndDate.ToString("dd/MM/yyyy HH:mm")</dd>

                            @if (Model.PickupDate.HasValue)
                            {
                                <dt class="col-sm-5">Ngày nhận xe:</dt>
                                <dd class="col-sm-7">@Model.PickupDate.Value.ToString("dd/MM/yyyy HH:mm")</dd>
                            }

                            @if (Model.ReturnDate.HasValue)
                            {
                                <dt class="col-sm-5">Ngày trả xe:</dt>
                                <dd class="col-sm-7">@Model.ReturnDate.Value.ToString("dd/MM/yyyy HH:mm")</dd>
                            }
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Tổng giá trị:</dt>
                            <dd class="col-sm-7"><strong class="text-success">@Model.TotalPrice.ToString("N0") VNĐ</strong></dd>

                            @if (Model.Deposit.HasValue && Model.Deposit > 0)
                            {
                                <dt class="col-sm-5">Tiền đặt cọc:</dt>
                                <dd class="col-sm-7">@Model.Deposit.Value.ToString("N0") VNĐ</dd>
                            }

                            @if (Model.LateFee.HasValue && Model.LateFee > 0)
                            {
                                <dt class="col-sm-5">Phí trễ hạn:</dt>
                                <dd class="col-sm-7"><span class="text-danger">@Model.LateFee.Value.ToString("N0") VNĐ</span></dd>
                            }

                            @if (Model.DamageFee.HasValue && Model.DamageFee > 0)
                            {
                                <dt class="col-sm-5">Phí hư hỏng:</dt>
                                <dd class="col-sm-7"><span class="text-warning">@Model.DamageFee.Value.ToString("N0") VNĐ</span></dd>
                            }

                            <dt class="col-sm-5">Số ngày thuê:</dt>
                            <dd class="col-sm-7">
                                <span class="badge bg-info">@((Model.EndDate.Date - Model.StartDate.Date).Days) ngày</span>
                            </dd>

                            <dt class="col-sm-5">Ngày tạo:</dt>
                            <dd class="col-sm-7">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</dd>

                            <dt class="col-sm-5">Cập nhật cuối:</dt>
                            <dd class="col-sm-7">@Model.UpdatedAt.ToString("dd/MM/yyyy HH:mm")</dd>
                        </dl>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.Notes))
                {
                    <div class="mt-3">
                        <h6>Ghi chú:</h6>
                        <div class="alert alert-info">
                            @Model.Notes
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Car Information -->
        @if (Model.Car != null)
        {
            var primaryImage = Model.Car.CarImages?.FirstOrDefault(img => img.IsPrimary);

            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Thông tin xe</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            @if (primaryImage != null && !string.IsNullOrEmpty(primaryImage.ImageUrl))
                            {
                                <img src="@primaryImage.ImageUrl" alt="@Model.Car.Name" class="img-fluid rounded">
                            }
                            else
                            {
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="fas fa-car fa-3x text-muted"></i>
                                </div>
                            }
                        </div>
                        <div class="col-md-8">
                            <h5>@Model.Car.Name</h5>
                            <p class="text-muted">
                                @(Model.Car.Brand?.Name ?? "N/A") - @(Model.Car.Category?.Name ?? "N/A")
                            </p>

                            <dl class="row">
                                <dt class="col-sm-4">Giá thuê/ngày:</dt>
                                <dd class="col-sm-8">@Model.Car.PricePerDay.ToString("N0") VNĐ</dd>

                                @if (Model.Car.Year > 0)
                                {
                                    <dt class="col-sm-4">Năm sản xuất:</dt>
                                    <dd class="col-sm-8">@Model.Car.Year</dd>
                                }

                                @if (!string.IsNullOrEmpty(Model.Car.Color))
                                {
                                    <dt class="col-sm-4">Màu sắc:</dt>
                                    <dd class="col-sm-8">@Model.Car.Color</dd>
                                }

                                @if (!string.IsNullOrEmpty(Model.Car.LicensePlate))
                                {
                                    <dt class="col-sm-4">Biển số:</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge bg-dark">@Model.Car.LicensePlate</span>
                                    </dd>
                                }

                                @if (Model.Car.Seats.HasValue && Model.Car.Seats > 0)
                                {
                                    <dt class="col-sm-4">Số chỗ ngồi:</dt>
                                    <dd class="col-sm-8">@Model.Car.Seats chỗ</dd>
                                }

                                <dt class="col-sm-4">Trạng thái xe:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge bg-@(GetCarStatusBadgeClass(Model.Car.Status))">
                                        @(getCarStatusText != null ? getCarStatusText(Model.Car.Status) : Model.Car.Status.ToString())
                                    </span>
                                </dd>
                            </dl>

                            <a asp-controller="Cars" asp-action="Details" asp-route-id="@Model.Car.CarId"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> Xem chi tiết xe
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Payment History -->
        @if (payments.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Lịch sử thanh toán</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Loại</th>
                                    <th>Phương thức</th>
                                    <th>Số tiền</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var payment in payments)
                                {
                                    <tr>
                                        <td>
                                            @if (payment.Status == PaymentStatus.Completed)
                                            {
                                                @payment.PaymentDate.ToString("dd/MM/yyyy HH:mm")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chờ xác nhận</span>
                                            }
                                        </td>
                                        <td>@(getPaymentTypeText != null ? getPaymentTypeText(payment.PaymentType) : payment.PaymentType.ToString())</td>
                                        <td>@(getPaymentMethodText != null ? getPaymentMethodText(payment.PaymentMethod) : payment.PaymentMethod.ToString())</td>
                                        <td>
                                            <strong class="@(payment.Amount > 0 ? "text-success" : "text-danger")">
                                                @payment.Amount.ToString("N0") VNĐ
                                            </strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(GetPaymentStatusBadgeClass(payment.Status))">
                                                @(getPaymentStatusText != null ? getPaymentStatusText(payment.Status) : payment.Status.ToString())
                                            </span>
                                        </td>
                                        <td>
                                            @if (payment.Status == PaymentStatus.Pending)
                                            {
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <form asp-area="CarOwner" asp-controller="Payments" asp-action="Confirm" asp-route-id="@payment.PaymentId" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-success btn-sm" 
                                                                onclick="return confirm('Xác nhận đã nhận thanh toán @(payment.Amount.ToString("N0")) VNĐ?')">
                                                            <i class="fas fa-check"></i> Xác nhận
                                                        </button>
                                                    </form>
                                                    <form asp-area="CarOwner" asp-controller="Payments" asp-action="Reject" asp-route-id="@payment.PaymentId" method="post" class="d-inline ms-1">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-danger btn-sm" 
                                                                onclick="return confirm('Từ chối thanh toán này?')">
                                                            <i class="fas fa-times"></i> Từ chối
                                                        </button>
                                                    </form>
                                                </div>
                                            }
                                            else if (payment.Status == PaymentStatus.Completed)
                                            {
                                                <span class="text-success small">
                                                    <i class="fas fa-check-circle"></i> Đã xác nhận
                                                </span>
                                            }
                                            else if (payment.Status == PaymentStatus.Failed)
                                            {
                                                <span class="text-danger small">
                                                    <i class="fas fa-times-circle"></i> Đã từ chối
                                                </span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                                    <td colspan="3">
                                        <strong class="text-success">@payments.Where(p => p.Status == PaymentStatus.Completed).Sum(p => p.Amount).ToString("N0") VNĐ</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                @if (payments.Any(p => p.Status == PaymentStatus.Pending))
                {
                    <div class="card-footer bg-warning bg-opacity-10">
                        <small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Lưu ý:</strong> Có @payments.Count(p => p.Status == PaymentStatus.Pending) thanh toán đang chờ xác nhận. 
                            Vui lòng kiểm tra và xác nhận sau khi nhận được tiền từ khách hàng.
                        </small>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Status Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Trạng thái đơn thuê</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item @(GetTimelineStatus(RentalStatus.Pending, Model.Status))">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h6>Chờ xác nhận</h6>
                            <small>Đơn thuê đã được tạo</small>
                        </div>
                    </div>
                    <div class="timeline-item @(GetTimelineStatus(RentalStatus.Confirmed, Model.Status))">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h6>Đã xác nhận</h6>
                            <small>Chủ xe đã xác nhận</small>
                        </div>
                    </div>
                    <div class="timeline-item @(GetTimelineStatus(RentalStatus.Active, Model.Status))">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h6>Đang thuê</h6>
                            <small>Xe đang được sử dụng</small>
                        </div>
                    </div>
                    <div class="timeline-item @(GetTimelineStatus(RentalStatus.Completed, Model.Status))">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h6>Hoàn thành</h6>
                            <small>Đơn thuê đã kết thúc</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Tóm tắt thanh toán</h6>
            </div>
            <div class="card-body">
                <!-- ✅ THÊM: Progress Bar cho đặt cọc -->
                @if (Model.Status != RentalStatus.Completed && Model.Status != RentalStatus.Cancelled)
                {
                    <div class="mb-3">
                        <label class="form-label small mb-1">
                            <i class="fas fa-piggy-bank me-1"></i>
                            Đặt cọc (30% = @depositRequired.ToString("N0") VNĐ)
                        </label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar @(hasDeposit ? "bg-success" : "bg-warning")"
                                 role="progressbar"
                                 style="width: @((depositPaid / depositRequired * 100).ToString("F0"))%">
                                @depositPaid.ToString("N0") VNĐ (@((depositPaid / depositRequired * 100).ToString("F0"))%)
                            </div>
                        </div>
                        @if (!hasDeposit)
                        {
                            <small class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                Còn thiếu @((depositRequired - depositPaid).ToString("N0")) VNĐ
                            </small>
                        }
                    </div>
                    <hr />
                }

                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border-end">
                            <h4 class="text-success">@totalPaid.ToString("N0")</h4>
                            <small class="text-muted">Đã thanh toán</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-@(remainingAmount > 0 ? "warning" : "success")">@remainingAmount.ToString("N0")</h4>
                        <small class="text-muted">Còn lại</small>
                    </div>
                </div>

                <!-- ✅ THÊM: Progress Bar tổng thanh toán -->
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar @(isFullyPaid ? "bg-success" : "bg-info")"
                         role="progressbar"
                         style="width: @((totalPaid / Model.TotalPrice * 100).ToString("F0"))%">
                        @((totalPaid / Model.TotalPrice * 100).ToString("F0"))%
                    </div>
                </div>

                @if (hasPendingPayments)
                {
                    <div class="alert alert-warning mb-0 py-2">
                        <small><i class="fas fa-exclamation-triangle"></i> Có thanh toán đang chờ xử lý</small>
                    </div>
                }
                else if (isFullyPaid)
                {
                    <div class="alert alert-success mb-0 py-2">
                        <small><i class="fas fa-check-circle"></i> Đã thanh toán đầy đủ</small>
                    </div>
                }
                else if (remainingAmount > 0)
                {
                    <div class="alert alert-danger mb-0 py-2">
                        <small>
                            <i class="fas fa-money-bill-wave"></i>
                            Còn thiếu <strong>@remainingAmount.ToString("N0") VNĐ</strong>
                        </small>
                    </div>
                }
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Thao tác nhanh</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    @if (canConfirm)
                    {
                        @if (!hasDeposit)
                        {
                            <div class="alert alert-warning mb-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <small>
                                    <strong>Cần đặt cọc trước khi xác nhận</strong><br />
                                    Yêu cầu: @depositRequired.ToString("N0") VNĐ (30%)<br />
                                    Đã nhận: @depositPaid.ToString("N0") VNĐ<br />
                                    Còn thiếu: @((depositRequired - depositPaid).ToString("N0")) VNĐ
                                </small>
                            </div>
                        }

                        <!-- ✅ NÚT XÁC NHẬN ĐƠN GIẢN -->
                        <form asp-action="Confirm" asp-route-id="@Model.RentalId" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-success btn-sm w-100"
                                    disabled="@(!hasDeposit)"
                                    onclick="return confirm('@(Model.RequiresDriver ? "Lưu ý: Chỉ xác nhận khi đã có tài xế nhận đơn. Bạn có chắc muốn xác nhận?" : "Bạn có chắc muốn xác nhận đơn thuê này?")')">
                                <i class="fas fa-check"></i> Xác nhận đơn thuê
                            </button>
                        </form>
                        
                        @if (Model.RequiresDriver)
                        {
                            @if (string.IsNullOrEmpty(Model.DriverId))
                            {
                                <small class="text-muted mt-2">
                                    <i class="fas fa-info-circle"></i>
                                    Đơn cần tài xế. Tài xế sẽ tự nhận đơn sau khi bạn xác nhận đủ đặt cọc.
                                </small>
                            }
                            else if (Model.DriverAccepted != true)
                            {
                                <small class="text-warning mt-2">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Chờ tài xế @Model.Driver?.FullName chấp nhận đơn.
                                </small>
                            }
                        }
                    }
                    else
                    {
                        <!-- Hiển thị lý do không thể xác nhận -->
                        @if (Model.Status != RentalStatus.Pending)
                        {
                            <div class="alert alert-secondary mb-2">
                                <i class="fas fa-info-circle"></i>
                                <small>
                                    <strong>Không thể xác nhận:</strong><br />
                                    Trạng thái hiện tại: @(getRentalStatusText != null ? getRentalStatusText(Model.Status) : Model.Status.ToString())
                                </small>
                            </div>
                        }
                        else if (!hasDeposit)
                        {
                            <div class="alert alert-warning mb-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <small>
                                    <strong>Không thể xác nhận:</strong><br />
                                    Chưa đủ tiền đặt cọc<br />
                                    Yêu cầu: @depositRequired.ToString("N0") VNĐ (30%)<br />
                                    Đã nhận: @depositPaid.ToString("N0") VNĐ<br />
                                    Còn thiếu: @((depositRequired - depositPaid).ToString("N0")) VNĐ
                                </small>
                            </div>
                        }
                        else if (Model.RequiresDriver && string.IsNullOrEmpty(Model.DriverId))
                        {
                            <div class="alert alert-info mb-2">
                                <i class="fas fa-hourglass-half"></i>
                                <small>
                                    <strong>Chờ tài xế tự nhận đơn</strong><br />
                                    Đơn sẽ hiển thị cho tài xế sau khi đủ đặt cọc.
                                </small>
                            </div>
                        }
                        else if (Model.RequiresDriver && Model.DriverAccepted != true)
                        {
                            <div class="alert alert-warning mb-2">
                                <i class="fas fa-clock"></i>
                                <small>
                                    <strong>Chờ tài xế chấp nhận</strong><br />
                                    Tài xế: @Model.Driver?.FullName
                                </small>
                            </div>
                        }
                    }

                    @if (canStart)
                    {
                        @if (!hasDeposit)
                        {
                            <div class="alert alert-warning mb-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <small><strong>Cần đặt cọc đầy đủ trước khi bắt đầu</strong></small>
                            </div>
                        }

                        <form asp-action="Start" asp-route-id="@Model.RentalId" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-info btn-sm w-100"
                                    disabled="@(!hasDeposit)"
                                    onclick="return confirm('Bạn có chắc muốn bắt đầu đơn thuê này?')">
                                <i class="fas fa-play"></i> Bắt đầu thuê xe
                            </button>
                        </form>
                    }

                    @if (canComplete)
                    {
                        @if (!isFullyPaid)
                        {
                            <div class="alert alert-danger mb-2">
                                <i class="fas fa-exclamation-circle"></i>
                                <small>
                                    <strong>Không thể hoàn thành đơn</strong><br />
                                    Khách hàng còn nợ: @remainingAmount.ToString("N0") VNĐ<br />
                                    Yêu cầu thanh toán trước khi hoàn thành.
                                </small>
                            </div>
                        }

                        @if (isFullyPaid)
                        {
                            <a asp-action="Complete" asp-route-id="@Model.RentalId"
                               class="btn btn-primary btn-sm">
                                <i class="fas fa-flag-checkered"></i> Hoàn thành đơn thuê
                            </a>
                        }
                        else
                        {
                            <button type="button"
                                    class="btn btn-primary btn-sm disabled w-100"
                                    disabled
                                    title="Cần thanh toán đầy đủ trước khi hoàn thành">
                                <i class="fas fa-flag-checkered"></i> Hoàn thành đơn thuê
                            </button>
                        }
                    }

                    @if (canCancel)
                    {
                        <button type="button" class="btn btn-danger btn-sm" onclick="showCancelModal()">
                            <i class="fas fa-times"></i> Hủy đơn thuê
                        </button>
                    }

                    @if (!canConfirm && !canStart && !canComplete && !canCancel)
                    {
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            <small>Không có thao tác khả dụng cho trạng thái hiện tại</small>
                        </div>
                    }

                    <hr class="my-2">

                    <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list"></i> Danh sách đơn thuê
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ THÊM: Modal hủy đơn -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Hủy đơn thuê #@Model.RentalId
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    Bạn có chắc chắn muốn hủy đơn thuê này không?
                </p>
                <p class="text-danger">
                    <strong>Chú ý: </strong> Hành động này không thể hoàn tác.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <form asp-action="Cancel" asp-route-id="@Model.RentalId" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Hủy đơn thuê
                    </button>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function showCancelModal() {
            const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
            modal.show();
        }
    </script>
}

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

            .timeline-item:not(:last-child)::before {
                content: '';
                position: absolute;
                left: -23px;
                top: 20px;
                width: 2px;
                height: calc(100% - 10px);
                background-color: #e9ecef;
            }

            .timeline-item.completed::before {
                background-color: #28a745;
            }

        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e9ecef;
            border: 2px solid #fff;
        }

        .timeline-item.completed .timeline-marker {
            background-color: #28a745;
        }

        .timeline-item.active .timeline-marker {
            background-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
        }

        .timeline-content h6 {
            margin: 0;
            font-size: 0.9rem;
        }

        .timeline-content small {
            color: #6c757d;
        }

        .btn.disabled {
            pointer-events: none;
            opacity: 0.65;
            cursor: not-allowed !important;
        }
    </style>
}

@functions {
    private string GetRentalStatusBadgeClass(RentalStatus status)
    {
        return status switch
        {
            RentalStatus.Pending => "warning",
            RentalStatus.Confirmed => "info",
            RentalStatus.Active => "success",
            RentalStatus.Completed => "primary",
            RentalStatus.Cancelled => "danger",
            RentalStatus.Overdue => "danger",
            _ => "secondary"
        };
    }

    private string GetCarStatusBadgeClass(CarStatus status)
    {
        return status switch
        {
            CarStatus.Available => "success",
            CarStatus.Rented => "warning",
            CarStatus.Maintenance => "danger",
            CarStatus.PendingApproval => "secondary",
            CarStatus.Reserved => "info",
            _ => "secondary"
        };
    }

    private string GetPaymentStatusBadgeClass(PaymentStatus status)
    {
        return status switch
        {
            PaymentStatus.Pending => "warning",
            PaymentStatus.Completed => "success",
            PaymentStatus.Failed => "danger",
            PaymentStatus.Cancelled => "secondary",
            _ => "secondary"
        };
    }

    private string GetTimelineStatus(RentalStatus targetStatus, RentalStatus currentStatus)
    {
        var statusOrder = new Dictionary<RentalStatus, int>
        {
            [RentalStatus.Pending] = 1,
            [RentalStatus.Confirmed] = 2,
            [RentalStatus.Active] = 3,
            [RentalStatus.Completed] = 4
        };

        if (currentStatus == RentalStatus.Cancelled || currentStatus == RentalStatus.Overdue)
            return "";

        var targetOrder = statusOrder.GetValueOrDefault(targetStatus, 0);
        var currentOrder = statusOrder.GetValueOrDefault(currentStatus, 0);

        if (currentOrder > targetOrder)
            return "completed";
        else if (currentOrder == targetOrder)
            return "active";
        else
            return "";
    }

    // ✅ THÊM: Helper function cho driver alert class
    private string GetDriverAlertClass(Rental rental)
    {
        if (!rental.RequiresDriver)
            return "alert-info";
        
        if (string.IsNullOrEmpty(rental.DriverId))
            return "alert-warning";
        
        if (rental.DriverAccepted == null)
            return "alert-warning";
        
        if (rental.DriverAccepted == true)
            return "alert-success";
        
        if (rental.DriverAccepted == false)
            return "alert-danger";
        
        return "alert-info";
    }
}