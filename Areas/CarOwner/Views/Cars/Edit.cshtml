@using carrentalmvc.Models
@using carrentalmvc.Models.Enums
@model Car
@{
    ViewData["Title"] = $"Chỉnh sửa xe - {Model.Name}";
    
    // Get data from ViewBag
    var brands = ViewBag.Brands as SelectList;
    var categories = ViewBag.Categories as SelectList;
    var features = ViewBag.Features as IEnumerable<Feature> ?? new List<Feature>();
    var templates3D = ViewBag.Templates3D as IEnumerable<Model3DTemplate> ?? new List<Model3DTemplate>();
    
    // Get existing data from ViewBag
    var existingImages = ViewBag.ExistingImages as List<CarImage> ?? new List<CarImage>();
    var selectedFeatureIds = ViewBag.SelectedFeatureIds as List<int> ?? new List<int>();
    
    // Get current 3D model info from ViewBag
    var current3DTemplateId = ViewBag.Current3DTemplateId as int?;
    var current3DModelUrl = ViewBag.Current3DModelUrl as string;
    var current3DFileFormat = ViewBag.Current3DFileFormat as FileFormat?;
    var current3DTemplateName = ViewBag.Current3DTemplateName as string;
}
<script type="module" src="https://unpkg.com/@@google/model-viewer@@3.3.0/dist/model-viewer.min.js"></script>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Chỉnh sửa xe
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Thay đổi thông tin có thể ảnh hưởng đến đơn thuê đang hoạt động. Thay đổi giá chỉ áp dụng cho đơn thuê mới.
                    </div>

                    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editCarForm">
                        <input type="hidden" name="id" value="@Model.CarId" />
                        <input asp-for="OwnerId" type="hidden" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- THÔNG TIN CƠ BẢN -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin cơ bản</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="Name" class="form-label"></label>
                                            <input asp-for="Name" class="form-control" placeholder="VD: Toyota Vios 2024" />
                                            <span asp-validation-for="Name" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="LicensePlate" class="form-label"></label>
                                            <input asp-for="LicensePlate" class="form-control" placeholder="VD: 30A-12345" />
                                            <span asp-validation-for="LicensePlate" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="BrandId" class="form-label"></label>
                                            <select asp-for="BrandId" asp-items="brands" class="form-select" id="brandSelect">
                                                <option value="">-- Chọn thương hiệu --</option>
                                            </select>
                                            <span asp-validation-for="BrandId" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="CategoryId" class="form-label"></label>
                                            <select asp-for="CategoryId" asp-items="categories" class="form-select" id="categorySelect">
                                                <option value="">-- Chọn loại xe --</option>
                                            </select>
                                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="Year" class="form-label"></label>
                                            <input asp-for="Year" type="number" class="form-control" placeholder="2024" />
                                            <span asp-validation-for="Year" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="Description" class="form-label"></label>
                                    <textarea asp-for="Description" class="form-control" rows="4" placeholder="Mô tả chi tiết về xe..."></textarea>
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- THÔNG SỐ KỸ THUẬT -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Thông số kỹ thuật</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="Seats" class="form-label"></label>
                                            <input asp-for="Seats" type="number" class="form-control" placeholder="5" />
                                            <span asp-validation-for="Seats" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="Color" class="form-label"></label>
                                            <input asp-for="Color" class="form-control" placeholder="Trắng" />
                                            <span asp-validation-for="Color" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="Transmission" class="form-label"></label>
                                            <select asp-for="Transmission" class="form-select">
                                                <option value="">-- Chọn hộp số --</option>
                                                <option value="@Transmission.Manual">Số sàn</option>
                                                <option value="@Transmission.Automatic">Số tự động</option>
                                                <option value="@Transmission.CVT">CVT</option>
                                            </select>
                                            <span asp-validation-for="Transmission" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="FuelType" class="form-label"></label>
                                            <select asp-for="FuelType" class="form-select">
                                                <option value="">-- Chọn nhiên liệu --</option>
                                                <option value="@FuelType.Gasoline">Xăng</option>
                                                <option value="@FuelType.Diesel">Dầu</option>
                                                <option value="@FuelType.Hybrid">Hybrid</option>
                                                <option value="@FuelType.Electric">Điện</option>
                                            </select>
                                            <span asp-validation-for="FuelType" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="FuelConsumption" class="form-label"></label>
                                            <div class="input-group">
                                                <input asp-for="FuelConsumption" type="number" step="0.1" class="form-control" placeholder="6.5" />
                                                <span class="input-group-text">L/100km</span>
                                            </div>
                                            <span asp-validation-for="FuelConsumption" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="PricePerDay" class="form-label"></label>
                                            <div class="input-group">
                                                <input asp-for="PricePerDay" type="number" class="form-control" placeholder="500000" />
                                                <span class="input-group-text">VNĐ</span>
                                            </div>
                                            <span asp-validation-for="PricePerDay" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="PricePerHour" class="form-label"></label>
                                            <div class="input-group">
                                                <input asp-for="PricePerHour" type="number" class="form-control" placeholder="50000" />
                                                <span class="input-group-text">VNĐ</span>
                                            </div>
                                            <span asp-validation-for="PricePerHour" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- HÌNH ẢNH XE -->
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0"><i class="fas fa-images me-2"></i>Quản lý hình ảnh xe</h5>
                            </div>
                            <div class="card-body">
                                <!-- Existing Images -->
                                @if (existingImages.Any())
                                {
                                    <div class="mb-4">
                                        <label class="form-label">Hình ảnh hiện tại:</label>
                                        <div class="row" id="existingImages">
                                            @for (int i = 0; i < existingImages.Count; i++)
                                            {
                                                var img = existingImages[i];
                                                <div class="col-md-3 col-sm-4 col-6 mb-3" data-image-id="@img.CarImageId">
                                                    <div class="existing-image-item position-relative">
                                                        <img src="@img.ImageUrl" alt="Existing image"
                                                             class="img-fluid rounded" style="width: 100%; height: 150px; object-fit: cover;">
                                                        <div class="position-absolute top-0 start-0 p-1">
                                                            @if (img.IsPrimary)
                                                            {
                                                                <span class="badge bg-success">Ảnh chính</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-primary">Ảnh @(i + 1)</span>
                                                            }
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                                                                onclick="markImageForDeletion(@img.CarImageId, this)" title="Xóa ảnh này">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        <!-- Hidden inputs for images to delete -->
                                        <div id="imagesToDeleteContainer"></div>
                                    </div>
                                }

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Lưu ý:</strong> Bạn có thể thêm hình ảnh mới hoặc xóa hình ảnh cũ.
                                    Ảnh mới sẽ được thêm vào danh sách hiện có.
                                </div>

                                <!-- Image Upload Area -->
                                <div class="mb-4">
                                    <label class="form-label">Thêm hình ảnh mới:</label>
                                    <div class="image-upload-area" id="imageUploadArea">
                                        <div class="upload-box" id="uploadBox">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted mb-2">Kéo thả hình ảnh vào đây hoặc</p>
                                            <button type="button" class="btn btn-outline-primary" id="selectImagesBtn">
                                                <i class="fas fa-folder-open me-2"></i>Chọn hình ảnh
                                            </button>
                                            <input type="file" id="newPrimaryImage" name="newPrimaryImage" accept="image/*" style="display: none;" />
                                            <input type="file" id="newAdditionalImages" name="newAdditionalImages" multiple accept="image/*" style="display: none;" />
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    Hỗ trợ: JPG, PNG, GIF. Tối đa 5 ảnh mới, mỗi ảnh không quá 5MB.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- New Image Preview Area -->
                                <div id="imagePreviewArea" style="display: none;">
                                    <label class="form-label">Hình ảnh mới được chọn:</label>
                                    <div class="row" id="imagePreviewContainer">
                                        <!-- Image previews will be added here dynamically -->
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-secondary" id="clearImagesBtn">
                                            <i class="fas fa-trash me-2"></i>Xóa tất cả ảnh mới
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- MÔ HÌNH 3D -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-cube me-2"></i>Mô hình 3D (tùy chọn)</h5>
                            </div>
                            <div class="card-body">
                                <!-- Current 3D Model Info -->
                                @if (current3DTemplateId.HasValue || !string.IsNullOrEmpty(current3DModelUrl))
                                {
                                    <div class="alert alert-success mb-3">
                                        <h6><i class="fas fa-cube me-2"></i>Mô hình 3D hiện tại:</h6>
                                        @if (current3DTemplateId.HasValue)
                                        {
                                            <p class="mb-1"><strong>Template ID:</strong> @current3DTemplateId</p>
                                            @if (!string.IsNullOrEmpty(current3DTemplateName))
                                            {
                                                <p class="mb-1"><strong>Tên template:</strong> @current3DTemplateName</p>
                                            }
                                        }
                                        @if (!string.IsNullOrEmpty(current3DModelUrl))
                                        {
                                            <p class="mb-1"><strong>URL:</strong> @current3DModelUrl</p>
                                        }
                                        @if (current3DFileFormat.HasValue)
                                        {
                                            <p class="mb-0"><strong>Định dạng:</strong> @current3DFileFormat</p>
                                        }

                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-info" onclick="showCurrentModel3DPreview()">
                                                <i class="fas fa-eye me-1"></i>Xem mô hình hiện tại
                                            </button>
                                        </div>
                                    </div>
                                }

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Lưu ý:</strong> Bạn có thể thay đổi mô hình 3D hoặc giữ nguyên mô hình hiện tại.
                                    Nhấn nút "Xóa mô hình 3D" để xóa mô hình.
                                </div>

                                <!-- Filter for templates -->
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Lọc theo thương hiệu:</label>
                                            <select class="form-select" id="templateBrandFilter">
                                                <option value="">Tất cả thương hiệu</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Lọc theo loại xe:</label>
                                            <select class="form-select" id="templateCategoryFilter">
                                                <option value="">Tất cả loại xe</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Template Selection -->
                                <div class="mb-4">
                                    <label class="form-label">Chọn mô hình từ thư viện:</label>
                                    <div class="row" id="template3DGrid">
                                        @if (templates3D.Any())
                                        {
                                            @foreach (var template in templates3D)
                                            {
                                                var brandName = template.Brand?.Name ?? "Chung";
                                                var categoryName = template.Category?.Name ?? "Chung";
                                                var isSelected = current3DTemplateId.HasValue && current3DTemplateId.Value == template.TemplateId;
                                                
                                                <div class="col-md-4 col-lg-3 mb-3 template-item"
                                                     data-template-id="@template.TemplateId"
                                                     data-brand-id="@(template.BrandId ?? 0)"
                                                     data-category-id="@(template.CategoryId ?? 0)"
                                                     data-brand-name="@brandName"
                                                     data-category-name="@categoryName">
                                                    <div class="card template-card @(isSelected ? "selected" : "")">
                                                        <div class="card-body text-center p-2">
                                                            @if (!string.IsNullOrEmpty(template.PreviewImageUrl))
                                                            {
                                                                <img src="@template.PreviewImageUrl" alt="@template.Name"
                                                                     class="img-fluid rounded mb-2" style="height: 80px; object-fit: cover;">
                                                            }
                                                            else
                                                            {
                                                                <div class="bg-light rounded d-flex align-items-center justify-content-center mb-2"
                                                                     style="height: 80px;">
                                                                    <i class="fas fa-cube fa-2x text-muted"></i>
                                                                </div>
                                                            }
                                                            <h6 class="card-title small mb-1">@template.Name</h6>
                                                            <small class="text-muted">@template.FileFormat.ToString()</small>
                                                            <br>
                                                            <small class="text-muted">@brandName - @categoryName</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="col-12">
                                                <div class="text-center py-4 text-muted">
                                                    <i class="fas fa-cube fa-3x mb-3"></i>
                                                    <p>Chưa có mô hình 3D nào trong thư viện.</p>
                                                    <small>Bạn có thể nhập URL mô hình tùy chỉnh bên dưới.</small>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Hidden input for selected template -->
                                <input type="hidden" name="model3DTemplateId" id="selectedTemplateId" value="@(current3DTemplateId ?? 0)" />

                                <!-- Custom Model URL -->
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group mb-3">
                                            <label for="customModel3DUrl" class="form-label">URL mô hình 3D tùy chỉnh</label>
                                            <input type="text" name="customModel3DUrl" class="form-control" id="customModelUrl"
                                                   value="@current3DModelUrl"
                                                   placeholder="https://example.com/models/my-car.glb" />
                                            <div class="form-text">
                                                Nhập URL mô hình 3D tùy chỉnh nếu không chọn từ thư viện.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="model3DFileFormat" class="form-label">Định dạng file</label>
                                            <select name="model3DFileFormat" class="form-select">
                                                <option value="">-- Chọn định dạng --</option>
                                                <option value="@((int)FileFormat.GLB)" selected="@(current3DFileFormat == FileFormat.GLB)">GLB</option>
                                                <option value="@((int)FileFormat.GLTF)" selected="@(current3DFileFormat == FileFormat.GLTF)">GLTF</option>
                                                <option value="@((int)FileFormat.OBJ)" selected="@(current3DFileFormat == FileFormat.OBJ)">OBJ</option>
                                                <option value="@((int)FileFormat.FBX)" selected="@(current3DFileFormat == FileFormat.FBX)">FBX</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Clear 3D Model Button -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="remove3DModel" id="remove3DModel" value="true">
                                        <label class="form-check-label text-danger" for="remove3DModel">
                                            <i class="fas fa-trash me-1"></i>Xóa mô hình 3D hiện tại
                                        </label>
                                    </div>
                                </div>

                                <!-- 3D Preview -->
                                <div class="mt-3" id="model3DPreview" style="display: none;">
                                    <label class="form-label">Xem trước mô hình 3D:</label>
                                    <div class="border rounded p-3 bg-light text-center">
                                        <div id="model3DViewer" style="height: 300px; background: #f8f9fa; border-radius: 5px; position: relative;">
                                            <div class="d-flex align-items-center justify-content-center h-100">
                                                <div class="text-center">
                                                    <div class="spinner-border text-primary mb-2" role="status" id="loadingSpinner" style="display: none;">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="text-muted mb-0" id="previewText">Chọn mô hình để xem trước</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VỊ TRÍ XE -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Vị trí xe đang đỗ</h5>
                            </div>
                            <div class="card-body">
                                <!-- Current Location Info -->
                                @if (!string.IsNullOrEmpty(Model.Location) || (Model.Latitude.HasValue && Model.Longitude.HasValue))
                                {
                                    <div class="alert alert-success mb-3">
                                        <h6><i class="fas fa-map-marker-alt me-2"></i>Vị trí hiện tại:</h6>
                                        @if (!string.IsNullOrEmpty(Model.Location))
                                        {
                                            <p class="mb-1"><strong>Địa chỉ:</strong> @Model.Location</p>
                                        }
                                        @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                                        {
                                            <p class="mb-0"><strong>Tọa độ:</strong> @Model.Latitude.Value.ToString("F6"), @Model.Longitude.Value.ToString("F6")</p>
                                        }
                                    </div>
                                }

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Lưu ý:</strong> Cập nhật vị trí xe giúp tính phí giao xe chính xác cho khách hàng.
                                    Click vào bản đồ hoặc dùng nút "Vị trí hiện tại" để thay đổi.
                                </div>

                                <!-- Quick location buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Chọn nhanh thành phố:</label>
                                    <div class="btn-group flex-wrap" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary location-quick-btn" data-lat="21.0285" data-lng="105.8542" data-name="Hà Nội">
                                            <i class="fas fa-map-marker-alt me-1"></i>Hà Nội
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary location-quick-btn" data-lat="10.8231" data-lng="106.6297" data-name="TP. Hồ Chí Minh">
                                            <i class="fas fa-map-marker-alt me-1"></i>TP.HCM
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary location-quick-btn" data-lat="16.0471" data-lng="108.2068" data-name="Đà Nẵng">
                                            <i class="fas fa-map-marker-alt me-1"></i>Đà Nẵng
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success" id="getCurrentLocationBtn">
                                            <i class="fas fa-location-arrow me-1"></i>Vị trí hiện tại
                                        </button>
                                    </div>
                                </div>

                                <!-- Map -->
                                <div class="mb-3">
                                    <label class="form-label">Chọn vị trí chính xác trên bản đồ:</label>
                                    <div id="carLocationMap" style="height: 400px; border: 2px solid #dee2e6; border-radius: 8px;"></div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-hand-pointer me-1"></i>Nhấp vào bản đồ để thay đổi vị trí xe
                                    </small>
                                </div>

                                <!-- Location inputs -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="Location" class="form-label"></label>
                                            <input asp-for="Location" class="form-control" placeholder="VD: Bãi đỗ xe Vincom, Garage ABC..." />
                                            <span asp-validation-for="Location" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="Latitude" class="form-label"></label>
                                            <input asp-for="Latitude" type="number" step="0.000001" class="form-control" placeholder="21.028511" readonly />
                                            <span asp-validation-for="Latitude" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label asp-for="Longitude" class="form-label"></label>
                                            <input asp-for="Longitude" type="number" step="0.000001" class="form-control" placeholder="105.804817" readonly />
                                            <span asp-validation-for="Longitude" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TÍNH NĂNG -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Tính năng xe</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    @if (features.Any())
                                    {
                                        @foreach (var feature in features)
                                        {
                                            var isChecked = selectedFeatureIds.Contains(feature.FeatureId);
                                            <div class="col-md-4 col-lg-3 mb-3">
                                                <div class="form-check feature-checkbox">
                                                    <input class="form-check-input" type="checkbox"
                                                           name="selectedFeatureIds"
                                                           value="@feature.FeatureId"
                                                           id="feature_@feature.FeatureId"
                                                           @(isChecked ? "checked" : "") />
                                                    <label class="form-check-label" for="feature_@feature.FeatureId">
                                                        @if (!string.IsNullOrEmpty(feature.Icon))
                                                        {
                                                            <i class="@feature.Icon me-2"></i>
                                                        }
                                                        @feature.Name
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12">
                                            <p class="text-muted">Không có tính năng nào để chọn.</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- FORM ACTIONS -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a asp-action="Details" asp-route-id="@Model.CarId" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <span class="spinner-border spinner-border-sm me-2" role="status" id="submitSpinner" style="display: none;"></span>
                                <i class="fas fa-save me-2" id="submitIcon"></i>Cập nhật xe
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
        .feature-checkbox {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            transition: all 0.3s;
        }

            .feature-checkbox:hover {
                background-color: #f8f9fa;
                border-color: #007bff;
            }

            .feature-checkbox input:checked ~ label {
                color: #007bff;
                font-weight: 600;
            }

        #carLocationMap {
            cursor: crosshair;
        }

        .location-quick-btn {
            margin: 5px;
        }

        .btn-group {
            gap: 5px;
        }

        #getCurrentLocationBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .leaflet-marker-icon {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            background: #fafafa;
        }

            .image-upload-area:hover {
                border-color: #007bff;
                background: #f0f8ff;
            }

            .image-upload-area.dragover {
                border-color: #28a745;
                background: #f0fff0;
                transform: scale(1.02);
            }

        .image-preview-item {
            position: relative;
            border: 2px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }

            .image-preview-item:hover {
                border-color: #007bff;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

            .image-preview-item.primary {
                border-color: #28a745;
                background: #f8fff9;
            }

            .image-preview-item .remove-image {
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(220, 53, 69, 0.9);
                color: white;
                border: none;
                border-radius: 50%;
                width: 25px;
                height: 25px;
                display: flex;
                align-items-center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .image-preview-item:hover .remove-image {
                opacity: 1;
            }

            .image-preview-item .primary-badge {
                position: absolute;
                top: 5px;
                left: 5px;
                background: #28a745;
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                font-weight: bold;
            }

        .existing-image-item {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }

            .existing-image-item:hover {
                border-color: #ffc107;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

            .existing-image-item.marked-for-deletion {
                opacity: 0.4;
                border-color: #dc3545;
            }

        .template-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
        }

            .template-card:hover {
                border-color: #007bff;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

            .template-card.selected {
                border-color: #28a745;
                background-color: #f8fff9;
            }

                .template-card.selected::after {
                    content: '\f00c';
                    font-family: 'Font Awesome 5 Free';
                    font-weight: 900;
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    color: #28a745;
                    background: white;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items-center;
                    justify-content-center;
                    font-size: 12px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }

        .template-item {
            position: relative;
            transition: all 0.3s;
        }

            .template-item.hidden {
                display: none !important;
            }

        .form-loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variables
            let primaryImageFile = null;
            let additionalImageFiles = [];
            let imagesToDelete = [];
            let carMarker = null;
            let selectedTemplateId = @(current3DTemplateId ?? 0);

            // Initialize components
            initializeMap();
            initializeImageUpload();
            initialize3DModelSelection();
            initializeFormSubmission();

            // ===== MAP FUNCTIONALITY =====
            function initializeMap() {
                const defaultLat = @(Model.Latitude ?? 16.0471);
                const defaultLng = @(Model.Longitude ?? 108.2068);
                const carLocationMap = L.map('carLocationMap').setView([defaultLat, defaultLng],
                    @(Model.Latitude.HasValue ? "15" : "6"));

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 18
                }).addTo(carLocationMap);

                // Show existing location if available
                if (@(Model.Latitude.HasValue ? "true" : "false")) {
                    setCarLocation(defaultLat, defaultLng, false);
                }

                // Click on map to set location
                carLocationMap.on('click', function(e) {
                    setCarLocation(e.latlng.lat, e.latlng.lng);
                    reverseGeocode(e.latlng.lat, e.latlng.lng);
                });

                function setCarLocation(lat, lng, updateInputs = true) {
                    if (carMarker) {
                        carLocationMap.removeLayer(carMarker);
                    }

                    const redIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    carMarker = L.marker([lat, lng], { icon: redIcon })
                        .addTo(carLocationMap)
                        .bindPopup('<b>Vị trí xe</b><br>' + lat.toFixed(6) + ', ' + lng.toFixed(6))
                        .openPopup();

                    carLocationMap.setView([lat, lng], 15);

                    if (updateInputs) {
                        document.querySelector('input[name="Latitude"]').value = lat.toFixed(6);
                        document.querySelector('input[name="Longitude"]').value = lng.toFixed(6);
                    }
                }

                async function reverseGeocode(lat, lng) {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=vi`);
                        const data = await response.json();
                        const locationInput = document.querySelector('input[name="Location"]');
                        locationInput.value = data.display_name || `Vị trí ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    } catch (error) {
                        console.error('Reverse geocode error:', error);
                    }
                }

                document.querySelectorAll('.location-quick-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const lat = parseFloat(this.dataset.lat);
                        const lng = parseFloat(this.dataset.lng);
                        const name = this.dataset.name;

                        setCarLocation(lat, lng);
                        document.querySelector('input[name="Location"]').value = name;

                        document.querySelectorAll('.location-quick-btn').forEach(b => {
                            b.classList.remove('btn-primary');
                            b.classList.add('btn-outline-primary');
                        });
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    });
                });

                document.getElementById('getCurrentLocationBtn').addEventListener('click', function() {
                    if (!navigator.geolocation) {
                        showToast('error', 'Trình duyệt không hỗ trợ định vị.');
                        return;
                    }

                    const btn = this;
                    const originalHTML = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lấy...';

                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;

                            setCarLocation(lat, lng);
                            reverseGeocode(lat, lng);

                            btn.disabled = false;
                            btn.innerHTML = originalHTML;
                            showToast('success', 'Đã lấy vị trí hiện tại thành công!');
                        },
                        function(error) {
                            btn.disabled = false;
                            btn.innerHTML = originalHTML;

                            let errorMsg = 'Không thể lấy vị trí: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg += 'Bạn đã từ chối quyền truy cập vị trí.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg += 'Thông tin vị trí không khả dụng.';
                                    break;
                                case error.TIMEOUT:
                                    errorMsg += 'Yêu cầu lấy vị trí hết thời gian.';
                                    break;
                                default:
                                    errorMsg += error.message;
                            }
                            showToast('error', errorMsg);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            }

            // ===== IMAGE UPLOAD FUNCTIONALITY =====
            function initializeImageUpload() {
                const uploadArea = document.getElementById('imageUploadArea');
                const primaryImageInput = document.getElementById('newPrimaryImage');
                const additionalImagesInput = document.getElementById('newAdditionalImages');
                const selectImagesBtn = document.getElementById('selectImagesBtn');
                const clearImagesBtn = document.getElementById('clearImagesBtn');
                const imagePreviewArea = document.getElementById('imagePreviewArea');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');

                selectImagesBtn.addEventListener('click', () => primaryImageInput.click());

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    handleImageSelection(files);
                });

                primaryImageInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        primaryImageFile = e.target.files[0];
                        updateImagePreview();
                    }
                });

                additionalImagesInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    additionalImageFiles = additionalImageFiles.concat(files);
                    updateImagePreview();
                });

                clearImagesBtn.addEventListener('click', () => {
                    primaryImageFile = null;
                    additionalImageFiles = [];
                    primaryImageInput.value = '';
                    additionalImagesInput.value = '';
                    updateImagePreview();
                });

                function handleImageSelection(files) {
                    if (files.length === 0) return;

                    const maxSize = 5 * 1024 * 1024;
                    const validFiles = files.filter(file => {
                        if (!file.type.startsWith('image/')) {
                            showToast('error', `File ${file.name} không phải là hình ảnh.`);
                            return false;
                        }
                        if (file.size > maxSize) {
                            showToast('error', `File ${file.name} quá lớn (tối đa 5MB).`);
                            return false;
                        }
                        return true;
                    });

                    if (validFiles.length === 0) return;

                    if (!primaryImageFile) {
                        primaryImageFile = validFiles[0];
                        const dt = new DataTransfer();
                        dt.items.add(primaryImageFile);
                        primaryImageInput.files = dt.files;
                        validFiles.splice(0, 1);
                    }

                    if (validFiles.length > 0) {
                        additionalImageFiles = additionalImageFiles.concat(validFiles);
                        const dt = new DataTransfer();
                        additionalImageFiles.forEach(f => dt.items.add(f));
                        additionalImagesInput.files = dt.files;
                    }

                    updateImagePreview();
                }

                function updateImagePreview() {
                    const allFiles = [];
                    if (primaryImageFile) allFiles.push({ file: primaryImageFile, isPrimary: true });
                    additionalImageFiles.forEach(f => allFiles.push({ file: f, isPrimary: false }));

                    if (allFiles.length === 0) {
                        imagePreviewArea.style.display = 'none';
                        return;
                    }

                    imagePreviewArea.style.display = 'block';
                    imagePreviewContainer.innerHTML = '';

                    allFiles.forEach((item, index) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const col = document.createElement('div');
                            col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                            col.innerHTML = `
                                <div class="image-preview-item ${item.isPrimary ? 'primary' : ''}" data-index="${index}">
                                    <img src="${e.target.result}" alt="${item.file.name}" class="img-fluid" style="width: 100%; height: 150px; object-fit: cover;">
                                    <button type="button" class="remove-image" onclick="removeNewImage(${index}, ${item.isPrimary})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    ${item.isPrimary ? '<div class="primary-badge">Ảnh chính</div>' : ''}
                                </div>
                            `;
                            imagePreviewContainer.appendChild(col);
                        };
                        reader.readAsDataURL(item.file);
                    });
                }

                window.removeNewImage = function(index, isPrimary) {
                    if (isPrimary) {
                        primaryImageFile = null;
                        primaryImageInput.value = '';
                    } else {
                        const adjIndex = primaryImageFile ? index - 1 : index;
                        additionalImageFiles.splice(adjIndex, 1);
                        const dt = new DataTransfer();
                        additionalImageFiles.forEach(f => dt.items.add(f));
                        additionalImagesInput.files = dt.files;
                    }
                    updateImagePreview();
                };

                // Mark existing image for deletion
                window.markImageForDeletion = function(imageId, button) {
                    const imageItem = button.closest('[data-image-id]');
                    imageItem.querySelector('.existing-image-item').classList.toggle('marked-for-deletion');
                    
                    const index = imagesToDelete.indexOf(imageId);
                    if (index > -1) {
                        imagesToDelete.splice(index, 1);
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-outline-danger');
                        button.querySelector('i').classList.remove('fa-undo');
                        button.querySelector('i').classList.add('fa-times');
                    } else {
                        imagesToDelete.push(imageId);
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-danger');
                        button.querySelector('i').classList.remove('fa-times');
                        button.querySelector('i').classList.add('fa-undo');
                    }
                    
                    updateImagesToDeleteInputs();
                };

                function updateImagesToDeleteInputs() {
                    const container = document.getElementById('imagesToDeleteContainer');
                    container.innerHTML = '';
                    imagesToDelete.forEach(id => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'imagesToDelete';
                        input.value = id;
                        container.appendChild(input);
                    });
                }
            }

            // ===== 3D MODEL SELECTION FUNCTIONALITY =====
            function initialize3DModelSelection() {
                const templateCards = document.querySelectorAll('.template-card');
                const templateItems = document.querySelectorAll('.template-item');
                const templateIdInput = document.getElementById('selectedTemplateId');
                const customUrlInput = document.getElementById('customModelUrl');
                const model3DPreview = document.getElementById('model3DPreview');
                const previewText = document.getElementById('previewText');
                const loadingSpinner = document.getElementById('loadingSpinner');
                const brandFilter = document.getElementById('templateBrandFilter');
                const categoryFilter = document.getElementById('templateCategoryFilter');
                const remove3DModelCheckbox = document.getElementById('remove3DModel');

                initializeFilterDropdowns();

                templateCards.forEach(card => {
                    card.addEventListener('click', function() {
                        const templateItem = this.closest('.template-item');
                        const templateId = templateItem.dataset.templateId;

                        templateCards.forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');

                        selectedTemplateId = templateId;
                        templateIdInput.value = templateId;
                        customUrlInput.value = '';
                        remove3DModelCheckbox.checked = false;

                        showTemplatePreview(templateId);
                    });
                });

                if (customUrlInput) {
                    customUrlInput.addEventListener('input', function() {
                        if (this.value.trim()) {
                            templateCards.forEach(c => c.classList.remove('selected'));
                            selectedTemplateId = null;
                            templateIdInput.value = '';
                            remove3DModelCheckbox.checked = false;
                            showCustomPreview(this.value.trim());
                        } else {
                            hidePreview();
                        }
                    });
                }

                remove3DModelCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        templateCards.forEach(c => c.classList.remove('selected'));
                        selectedTemplateId = null;
                        templateIdInput.value = '';
                        customUrlInput.value = '';
                        hidePreview();
                    }
                });

                function initializeFilterDropdowns() {
                    const brands = new Set();
                    const categories = new Set();

                    templateItems.forEach(item => {
                        const brandName = item.dataset.brandName;
                        const categoryName = item.dataset.categoryName;

                        if (brandName && brandName !== 'Chung') brands.add(brandName);
                        if (categoryName && categoryName !== 'Chung') categories.add(categoryName);
                    });

                    Array.from(brands).sort().forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand;
                        option.textContent = brand;
                        brandFilter.appendChild(option);
                    });

                    Array.from(categories).sort().forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });
                }

                function filterTemplates() {
                    const selectedBrand = brandFilter.value;
                    const selectedCategory = categoryFilter.value;

                    templateItems.forEach(item => {
                        const itemBrand = item.dataset.brandName;
                        const itemCategory = item.dataset.categoryName;

                        const brandMatch = !selectedBrand || itemBrand === selectedBrand || itemBrand === 'Chung';
                        const categoryMatch = !selectedCategory || itemCategory === selectedCategory || itemCategory === 'Chung';

                        if (brandMatch && categoryMatch) {
                            item.classList.remove('hidden');
                            item.style.display = 'block';
                        } else {
                            item.classList.add('hidden');
                            item.style.display = 'none';
                        }
                    });
                }

                brandFilter.addEventListener('change', filterTemplates);
                categoryFilter.addEventListener('change', filterTemplates);

                function showTemplatePreview(templateId) {
                    if (model3DPreview) {
                        model3DPreview.style.display = 'block';
                        if (loadingSpinner) loadingSpinner.style.display = 'block';
                        if (previewText) previewText.textContent = 'Đang tải mô hình...';

                        setTimeout(() => {
                            if (loadingSpinner) loadingSpinner.style.display = 'none';
                            if (previewText) previewText.innerHTML = `<i class="fas fa-cube fa-2x text-success"></i><br><small class="text-success">Mô hình đã được chọn (ID: ${templateId})</small>`;
                        }, 1000);
                    }
                }

                function showCustomPreview(url) {
                    if (model3DPreview) {
                        model3DPreview.style.display = 'block';
                        if (loadingSpinner) loadingSpinner.style.display = 'block';
                        if (previewText) previewText.textContent = 'Đang kiểm tra URL...';

                        setTimeout(() => {
                            if (loadingSpinner) loadingSpinner.style.display = 'none';
                            if (previewText) {
                                const validExtensions = ['.glb', '.gltf', '.obj', '.fbx'];
                                const isValid = validExtensions.some(ext => url.toLowerCase().includes(ext));
                                if (isValid) {
                                    previewText.innerHTML = `<i class="fas fa-cube fa-2x text-primary"></i><br><small class="text-primary">URL mô hình hợp lệ</small>`;
                                } else {
                                    previewText.innerHTML = `<i class="fas fa-exclamation-triangle fa-2x text-warning"></i><br><small class="text-warning">Kiểm tra lại URL mô hình</small>`;
                                }
                            }
                        }, 500);
                    }
                }

                function hidePreview() {
                    if (model3DPreview) model3DPreview.style.display = 'none';
                }

                filterTemplates();

                // Show current model preview if exists
                if (selectedTemplateId > 0 || '@current3DModelUrl' !== '') {
                    setTimeout(() => showCurrentModel3DPreview(), 500);
                }
            }

            // ===== FORM SUBMISSION =====
            function initializeFormSubmission() {
                const form = document.getElementById('editCarForm');
                const submitBtn = document.getElementById('submitBtn');
                const submitSpinner = document.getElementById('submitSpinner');
                const submitIcon = document.getElementById('submitIcon');

                form.addEventListener('submit', function(e) {
                    submitBtn.disabled = true;
                    form.classList.add('form-loading');

                    if (submitSpinner) submitSpinner.style.display = 'inline-block';
                    if (submitIcon) submitIcon.style.display = 'none';
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...';
                });
            }

            // ===== UTILITY FUNCTIONS =====
            function showToast(type, message) {
                const toastClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
                const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

                const toast = document.createElement('div');
                toast.className = `alert ${toastClass} position-fixed top-0 end-0 m-3`;
                toast.style.zIndex = '9999';
                toast.style.minWidth = '300px';
                toast.innerHTML = `<i class="fas ${icon} me-2"></i>${message}`;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // ===== SHOW CURRENT 3D MODEL PREVIEW =====
            window.showCurrentModel3DPreview = function() {
                const model3DPreview = document.getElementById('model3DPreview');
                const previewText = document.getElementById('previewText');
                const loadingSpinner = document.getElementById('loadingSpinner');

                if (model3DPreview) {
                    model3DPreview.style.display = 'block';

                    const currentTemplateId = @(current3DTemplateId ?? 0);
                    const currentUrl = '@(current3DModelUrl ?? "")';
                    const currentTemplateName = '@(current3DTemplateName ?? "")';

                    if (currentTemplateId > 0) {
                        if (previewText) {
                            previewText.innerHTML = `<i class="fas fa-cube fa-2x text-success"></i><br>
                                <small class="text-success">
                                    <strong>Template hiện tại:</strong> ${currentTemplateName}<br>
                                    <strong>ID:</strong> ${currentTemplateId}
                                </small>`;
                        }
                    } else if (currentUrl) {
                        if (previewText) {
                            previewText.innerHTML = `<i class="fas fa-cube fa-2x text-info"></i><br>
                                <small class="text-info">
                                    <strong>URL tùy chỉnh:</strong><br>
                                    <div style="word-break: break-all; max-width: 500px; margin: 0 auto;">${currentUrl}</div>
                                </small>`;
                        }
                    }
                }
            };
        });
    </script>
}