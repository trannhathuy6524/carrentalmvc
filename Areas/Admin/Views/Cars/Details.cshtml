@using carrentalmvc.Models.Enums
@model carrentalmvc.Models.Car
@{
    ViewData["Title"] = $"Chi tiết xe - {Model.Name}";
    var primaryImage = Model.CarImages?.FirstOrDefault(img => img.IsPrimary);
    var imageUrls = Model.CarImages?.Select(img => img.ImageUrl).ToList() ?? new List<string>();
    var features = Model.CarFeatures?.Select(cf => cf.Feature).ToList() ?? new List<carrentalmvc.Models.Feature>();

    // Check if delivery service is available
    var hasDeliveryService = Model.MaxDeliveryDistance.HasValue && Model.MaxDeliveryDistance > 0;
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-car"></i> Chi tiết xe</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <div class="dropdown">
                <button class="btn btn-sm btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cogs"></i> Cập nhật trạng thái
                </button>
                <ul class="dropdown-menu">
                    @foreach (var status in Enum.GetValues<CarStatus>())
                    {
                        @if (status != Model.Status)
                        {
                            <li>
                                <form asp-action="UpdateStatus" asp-route-id="@Model.CarId" method="post" class="d-inline">
                                    <input type="hidden" name="status" value="@status" />
                                    <button type="submit" class="dropdown-item"
                                            onclick="return confirm('Bạn có chắc muốn cập nhật trạng thái xe?')">
                                        <i class="fas fa-@(GetStatusIcon(status))"></i>
                                        @GetStatusText(status)
                                    </button>
                                </form>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Car Images and 3D Model -->
    <div class="col-md-6">
        <!-- Car Images -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-images"></i> Hình ảnh xe</h6>
            </div>
            <div class="card-body">
                @if (imageUrls.Any())
                {
                    <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < imageUrls.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@imageUrls[i]" class="d-block w-100 rounded" alt="Car image" style="height: 300px; object-fit: cover;">
                                </div>
                            }
                        </div>
                        @if (imageUrls.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        }
                        <!-- Image indicators -->
                        <div class="carousel-indicators">
                            @for (int i = 0; i < imageUrls.Count; i++)
                            {
                                <button type="button" data-bs-target="#carImageCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-label="Slide @(i + 1)"></button>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 300px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-car fa-5x mb-3"></i>
                            <p>Chưa có hình ảnh</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- 3D Model Viewer -->
        @if (Model.CarModel3D != null && !string.IsNullOrEmpty(Model.CarModel3D.ModelUrl) &&
                (Model.CarModel3D.FileFormat == FileFormat.GLB || Model.CarModel3D.FileFormat == FileFormat.GLTF))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cube"></i> Mô hình 3D tương tác
                        <span class="badge bg-success ms-2">@Model.CarModel3D.FileFormat</span>
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div style="height: 400px;">
                        @await Html.PartialAsync("_Model3DViewer", Model.CarModel3D.ModelUrl)
                    </div>
                </div>
                <div class="card-footer text-muted small">
                    <i class="fas fa-mouse"></i> Sử dụng chuột để xoay, phóng to/thu nhỏ mô hình
                    <span class="float-end">
                        <i class="fas fa-mobile-alt"></i> Nhấn AR để xem trên điện thoại
                    </span>
                </div>
            </div>
        }

        <!-- Approval Section -->
        @if (Model.Status == CarStatus.PendingApproval)
        {
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-hourglass-half"></i> Duyệt xe</h6>
                </div>
                <div class="card-body">
                    <p>Xe này đang chờ duyệt. Vui lòng xem xét thông tin và quyết định:</p>

                    <div class="d-grid gap-2">
                        <form asp-action="Approve" asp-route-id="@Model.CarId" method="post" class="d-inline">
                            <div class="mb-3">
                                <label for="approveNotes" class="form-label">Ghi chú (tùy chọn)</label>
                                <textarea class="form-control" id="approveNotes" name="notes" rows="2"
                                      placeholder="Ghi chú khi duyệt xe..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success w-100"
                                    onclick="return confirm('Bạn có chắc muốn duyệt xe này?')">
                                <i class="fas fa-check"></i> Duyệt xe
                            </button>
                        </form>

                        <button type="button" class="btn btn-danger"
                                onclick="showRejectModal(@Model.CarId, '@Model.Name')">
                            <i class="fas fa-times"></i> Từ chối xe
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Car Features -->
        @if (features.Any())
        {
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-star"></i> Tính năng xe</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var feature in features)
                        {
                            <div class="col-md-6 mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="@(feature.Icon ?? "fas fa-check") text-primary me-2"></i>
                                    <span>@feature.Name</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Car Details -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin xe</h6>
                    <span class="badge bg-@(GetCarStatusBadgeClass(Model.Status)) fs-6">@GetStatusText(Model.Status)</span>
                </div>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8">#@Model.CarId</dd>

                    <dt class="col-sm-4">Tên xe:</dt>
                    <dd class="col-sm-8">
                        <h5 class="text-primary mb-0">@Model.Name</h5>
                    </dd>

                    <dt class="col-sm-4">Thương hiệu:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info">@Model.Brand?.Name</span>
                    </dd>

                    <dt class="col-sm-4">Loại xe:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-secondary">@Model.Category?.Name</span>
                    </dd>

                    <dt class="col-sm-4">Năm sản xuất:</dt>
                    <dd class="col-sm-8">
                        <strong>@Model.Year</strong>
                    </dd>

                    <dt class="col-sm-4">Màu sắc:</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.Color))
                        {
                            <span class="badge bg-light text-dark" style="border: 1px solid #dee2e6;">
                                <i class="fas fa-palette me-1"></i>@Model.Color
                            </span>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>

                    <dt class="col-sm-4">Biển số:</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.LicensePlate))
                        {
                            <span class="badge bg-dark">@Model.LicensePlate</span>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>

                    <dt class="col-sm-4">Số chỗ ngồi:</dt>
                    <dd class="col-sm-8">
                        @if (Model.Seats.HasValue && Model.Seats > 0)
                        {
                            <span class="badge bg-primary">
                                <i class="fas fa-users me-1"></i>@Model.Seats chỗ
                            </span>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>

                    <dt class="col-sm-4">Hộp số:</dt>
                    <dd class="col-sm-8">
                        @if (Model.Transmission.HasValue)
                        {
                            <span class="badge bg-success">@GetTransmissionText(Model.Transmission)</span>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>

                    <dt class="col-sm-4">Nhiên liệu:</dt>
                    <dd class="col-sm-8">
                        @if (Model.FuelType.HasValue)
                        {
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-gas-pump me-1"></i>@GetFuelTypeText(Model.FuelType)
                            </span>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>

                    @if (Model.FuelConsumption.HasValue)
                    {
                        <dt class="col-sm-4">Tiêu thụ:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">@Model.FuelConsumption L/100km</span>
                        </dd>
                    }
                </dl>
            </div>
        </div>

        <!-- Pricing -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-money-bill-wave"></i> Giá thuê</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-success">@Model.PricePerDay.ToString("N0")</h4>
                            <small class="text-muted">VNĐ/ngày</small>
                        </div>
                    </div>
                    <div class="col-6">
                        @if (Model.PricePerHour.HasValue)
                        {
                            <h4 class="text-info">@Model.PricePerHour.Value.ToString("N0")</h4>
                            <small class="text-muted">VNĐ/giờ</small>
                        }
                        else
                        {
                            <h4 class="text-muted">N/A</h4>
                            <small class="text-muted">VNĐ/giờ</small>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-shipping-fast"></i> Cấu hình giao xe
                    @if (hasDeliveryService)
                    {
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-check-circle"></i> Có giao xe
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-secondary ms-2">
                            <i class="fas fa-times-circle"></i> Không giao xe
                        </span>
                    }
                </h6>
            </div>
            <div class="card-body">
                @if (hasDeliveryService)
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <td class="text-muted" style="width: 60%;">
                                        <i class="fas fa-map-marked-alt text-primary me-1"></i>
                                        Khoảng cách giao xe tối đa:
                                    </td>
                                    <td>
                                        <span class="badge bg-primary fs-6">
                                            <i class="fas fa-ruler-horizontal"></i>
                                            @Model.MaxDeliveryDistance km
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">
                                        <i class="fas fa-dollar-sign text-success me-1"></i>
                                        Phí giao xe mỗi km:
                                    </td>
                                    <td>
                                        @if (Model.PricePerKmDelivery.HasValue && Model.PricePerKmDelivery > 0)
                                        {
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-coins"></i>
                                                @Model.PricePerKmDelivery.Value.ToString("N0") VNĐ/km
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info fs-6">
                                                <i class="fas fa-gift"></i> Miễn phí
                                            </span>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Delivery Fee Calculator Preview -->
                    @if (Model.PricePerKmDelivery.HasValue && Model.PricePerKmDelivery > 0)
                    {
                        <hr class="my-3">
                        <div class="mb-2">
                            <small class="text-muted fw-bold">
                                <i class="fas fa-calculator me-1"></i>Ước tính phí giao xe:
                            </small>
                        </div>
                        <div class="row g-2 text-center">
                            @{
                                var distances = new[] { 10, 25, 50 };
                                foreach (var dist in distances)
                                {
                                    var isInRange = dist <= Model.MaxDeliveryDistance.Value;
                                    var fee = isInRange ? dist * Model.PricePerKmDelivery.Value : 0;

                                    <div class="col-4">
                                        <div class="p-2 @(isInRange ? "bg-light border border-primary" : "bg-secondary bg-opacity-10 border") rounded">
                                            <div class="small text-muted mb-1">
                                                <i class="fas fa-map-marker-alt"></i> @dist km
                                            </div>
                                            @if (isInRange)
                                            {
                                                <div class="fw-bold text-primary">@fee.ToString("N0") VNĐ</div>
                                            }
                                            else
                                            {
                                                <div class="small text-muted">
                                                    <i class="fas fa-ban"></i><br />
                                                    Ngoài phạm vi
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Delivery Info Alert -->
                    <div class="alert alert-success mt-3 mb-0">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div class="small">
                                <strong>Dịch vụ giao xe:</strong>
                                <ul class="mb-0 mt-1 ps-3">
                                    <li>Phạm vi giao xe: <strong>@Model.MaxDeliveryDistance km</strong> từ vị trí xe</li>
                                    <li>
                                        Chi phí:
                                        @if (Model.PricePerKmDelivery.HasValue && Model.PricePerKmDelivery > 0)
                                        {
                                            <strong>@Model.PricePerKmDelivery.Value.ToString("N0") VNĐ/km</strong>
                                        }
                                        else
                                        {
                                            <strong class="text-success">Miễn phí</strong>
                                        }
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div class="small">
                                <strong>Không cung cấp dịch vụ giao xe</strong>
                                <p class="mb-0 mt-1">
                                    Chủ xe chưa cấu hình dịch vụ giao xe.
                                    Khách hàng cần đến vị trí xe để nhận xe.
                                </p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Location Information -->
        @if (!string.IsNullOrEmpty(Model.Location) || (Model.Latitude.HasValue && Model.Longitude.HasValue))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Vị trí xe</h6>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <p class="mb-2"><i class="fas fa-map-marked-alt text-primary"></i> @Model.Location</p>
                    }
                    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                    {
                        <p class="mb-0 small text-muted">
                            <i class="fas fa-crosshairs"></i>
                            Tọa độ: @Model.Latitude.Value.ToString("F6"), @Model.Longitude.Value.ToString("F6")
                        </p>
                        <div class="mt-2">
                            <a href="https://www.google.com/maps?q=@Model.Latitude,@Model.Longitude"
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Xem trên Google Maps
                            </a>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Owner Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user-tie"></i> Thông tin chủ xe</h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Tên:</dt>
                    <dd class="col-sm-8">@Model.Owner?.FullName</dd>

                    <dt class="col-sm-4">Điện thoại:</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.Owner?.PhoneNumber))
                        {
                            <a href="tel:@Model.Owner.PhoneNumber" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-phone"></i> @Model.Owner.PhoneNumber
                            </a>
                        }
                        else
                        {
                            <em class="text-muted">Chưa cập nhật</em>
                        }
                    </dd>
                </dl>

                <div class="d-grid">
                    <a asp-area="Admin" asp-controller="Users" asp-action="Details" asp-route-id="@Model.Owner?.UserName"
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user"></i> Xem hồ sơ chủ xe
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Description -->
@if (!string.IsNullOrEmpty(Model.Description))
{
    <div class="card mt-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-align-left"></i> Mô tả xe</h6>
        </div>
        <div class="card-body">
            <p class="mb-0">@Model.Description</p>
        </div>
    </div>
}

@functions {
    private string GetCarStatusBadgeClass(CarStatus status)
    {
        return status switch
        {
            CarStatus.Available => "success",
            CarStatus.Rented => "warning",
            CarStatus.Maintenance => "danger",
            CarStatus.PendingApproval => "secondary",
            _ => "secondary"
        };
    }

    private string GetStatusIcon(CarStatus status)
    {
        return status switch
        {
            CarStatus.Available => "check",
            CarStatus.Rented => "clock",
            CarStatus.Maintenance => "wrench",
            CarStatus.PendingApproval => "hourglass-half",
            _ => "question"
        };
    }

    private string GetStatusText(CarStatus status)
    {
        return status switch
        {
            CarStatus.Available => "Sẵn sàng",
            CarStatus.Rented => "Đang thuê",
            CarStatus.Maintenance => "Bảo trì",
            CarStatus.PendingApproval => "Chờ duyệt",
            _ => "Không xác định"
        };
    }

    private string? GetTransmissionText(Transmission? transmission)
    {
        return transmission switch
        {
            Transmission.Manual => "Số sàn",
            Transmission.Automatic => "Số tự động",
            Transmission.CVT => "CVT",
            _ => null
        };
    }

    private string? GetFuelTypeText(FuelType? fuelType)
    {
        return fuelType switch
        {
            FuelType.Gasoline => "Xăng",
            FuelType.Diesel => "Dầu",
            FuelType.Hybrid => "Hybrid",
            FuelType.Electric => "Điện",
            _ => null
        };
    }
}